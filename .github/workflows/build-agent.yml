name: Build and Test Agent (CI)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'scripts/local-agent.js'
      - 'scripts/runner-core-selenium.js'
      - 'scripts/copy-chromedriver.js'
      - 'scripts/copy-runtime-deps.js'
      - 'scripts/generate-dist-readme.js'
      - 'package.json'
      - 'package-lock.json'
  pull_request:
    branches: [ main ]
    paths:
      - 'scripts/local-agent.js'
      - 'scripts/runner-core-selenium.js'
      - 'scripts/copy-chromedriver.js'
      - 'scripts/copy-runtime-deps.js'
      - 'scripts/generate-dist-readme.js'
      - 'package.json'
      - 'package-lock.json'

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install deps
        run: npm ci
      - name: Build agent exe + copy runtime deps
        run: npm run pkg:agent:win:with-chromedriver
      - name: Upload artifact (full dist)
        uses: actions/upload-artifact@v4
        with:
          name: idt-agent-windows
          path: dist/**
          if-no-files-found: error
      - name: Portability smoke test (moved folder)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $dst = "$env:TEMP\idt-agent-portable-test"
          if (Test-Path $dst) { Remove-Item -Recurse -Force $dst }
          New-Item -ItemType Directory -Path $dst | Out-Null
          Copy-Item -Recurse -Force .\dist\* $dst
          # quick file assertions
          if (!(Test-Path "$dst\idt-agent.exe")) { throw 'idt-agent.exe missing' }
          if (!(Test-Path "$dst\runner-core-selenium.js")) { throw 'runner-core-selenium.js missing' }
          if (!(Test-Path "$dst\chromedriver.exe")) { throw 'chromedriver.exe missing' }
          if (!(Test-Path "$dst\node_modules\selenium-webdriver")) { throw 'selenium-webdriver missing' }
          if (!(Test-Path "$dst\node_modules\tmp")) { throw 'tmp module missing' }
          if (!(Test-Path "$dst\node_modules\jszip")) { throw 'jszip module missing' }
          if (!(Test-Path "$dst\node_modules\setimmediate")) { throw 'setimmediate module missing' }
          if (!(Test-Path "$dst\node_modules\ws")) { throw 'ws module missing' }
          if (!(Test-Path "$dst\node_modules\@bazel\runfiles")) { throw '@bazel/runfiles module missing' }
          $env:IDT_AGENT_PORT = '4799'
          $p = Start-Process -FilePath "$dst\idt-agent.exe" -PassThru
          try {
            Start-Sleep -Seconds 2
            $res = Invoke-WebRequest -Uri "http://127.0.0.1:$($env:IDT_AGENT_PORT)/health" -UseBasicParsing -TimeoutSec 5
            if ($res.StatusCode -ne 200) { throw "health returned $($res.StatusCode)" }
          } finally {
            try { Stop-Process -Id $p.Id -Force } catch {}
          }

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install deps
        run: npm ci
      - name: Build agent (mac) and copy runtime deps
        run: |
          npm run pkg:agent:mac
          node scripts/copy-chromedriver.js || true
          node scripts/copy-runtime-deps.js || true
      - name: Upload artifact (full dist)
        uses: actions/upload-artifact@v4
        with:
          name: idt-agent-macos
          path: dist/**
          if-no-files-found: error
      - name: Portability smoke test (moved folder)
        run: |
          set -euo pipefail
          dst="$(mktemp -d)"/idt-agent-portable-test
          mkdir -p "$dst"
          cp -R dist/* "$dst"/
          test -f "$dst/idt-agent" || { echo 'idt-agent missing' ; exit 1; }
          test -f "$dst/runner-core-selenium.js" || { echo 'runner-core-selenium.js missing'; exit 1; }
          test -d "$dst/node_modules/selenium-webdriver" || { echo 'selenium-webdriver missing'; exit 1; }
          test -d "$dst/node_modules/tmp" || { echo 'tmp missing'; exit 1; }
          test -d "$dst/node_modules/jszip" || { echo 'jszip missing'; exit 1; }
          test -d "$dst/node_modules/ws" || { echo 'ws missing'; exit 1; }
          test -d "$dst/node_modules/@bazel/runfiles" || { echo '@bazel/runfiles missing'; exit 1; }
          export IDT_AGENT_PORT=4799
          # Ensure binary is executable
          chmod +x "$dst/idt-agent" || true
          # Start agent and capture logs for debugging
          AGENT_LOG="$dst/agent.log"
          "$dst/idt-agent" > "$AGENT_LOG" 2>&1 &
          pid=$!
          # Poll /health for up to 15 seconds
          ok=1
          for i in $(seq 1 15); do
            if curl -sf "http://127.0.0.1:${IDT_AGENT_PORT}/health" >/dev/null 2>&1; then
              ok=0
              break
            fi
            sleep 1
          done
          if [ "$ok" -ne 0 ]; then
            echo 'Portability smoke test failed: /health not reachable. Agent log follows:'
            sed -n '1,200p' "$AGENT_LOG" || true
            kill "$pid" || true
            exit 1
          fi
          # success - stop agent
          kill "$pid" || true
